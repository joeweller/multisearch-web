<!DOCTYPE html>
<html>
  <header>
    <style>
      span + span {
        margin-left: 2em;
      }
      span {
        cursor: pointer;
      }
    </style>
    <title>multisearch</title>
    <script type="text/javascript" src="./siteData.js"></script>
  </header>
  <body>
    <div>
      <input id="search" type="text" />
    </div>
    <div id="sites"></div>
    <script>
      let categories = [
        "general",
        "home",
        "fashion",
        "beauty",
        "entertainment",
        "hardware",
        "health",
        "technology",
      ];

      var searchNode = document.getElementById("search");
      var sitesNode = document.getElementById("sites");

      var processSearch = (event) => {
        let term = searchNode.value;
        let siteConfig = siteData[event.target.id];
        if (term !== undefined && term.length && siteConfig !== undefined) {
          window.open(
            siteConfig["url"].replace(
              "{!TERM}",
              transformTerm(term, siteConfig)
            ),
            "_blank"
          );
        }
      };

      var transformTerm = (term, siteConfig) => {
        // pre-transform
        Object.getOwnPropertyNames(siteConfig["preTransformMap"]).forEach(
          (char) => {
            term = term.replaceAll(char, siteConfig["preTransformMap"][char]);
          }
        );
        //console.log(term);

        // post-transform
        if (
          siteConfig["postTransformFunc"] !== undefined &&
          siteConfig["postTransformFunc"].length
        ) {
          switch (siteConfig["postTransformFunc"]) {
            case "URLENCODE":
              term = encodeURIComponent(term);
              break;
          }
        }
        return term;
      };

      var init = () => {
        console.log(`Document is ready!`);
        let categorySitesMap = {};
        Object.getOwnPropertyNames(siteData).forEach((siteConfigId) => {
          siteData[siteConfigId]["categories"].forEach((category) => {
            if (categorySitesMap[category] === undefined) {
              categorySitesMap[category] = [];
            }
            categorySitesMap[category].push(siteConfigId);
          });
        });

        categories.forEach((category) => {
          let categoryTextNode = document.createElement("h2");
          categoryTextNode.innerText = category;

          let categoryNode = document.createElement("div");
          categoryNode.id = category;
          categoryNode.appendChild(categoryTextNode);

          if (
            categorySitesMap[category] !== undefined &&
            categorySitesMap[category].length
          ) {
            categorySitesMap[category].sort().forEach((siteId) => {
              let ele = document.createElement("span");
              ele.innerText = siteData[siteId].brand;
              ele.id = siteId;
              ele.addEventListener("click", processSearch);
              categoryNode.appendChild(ele);
            });
            sitesNode.appendChild(categoryNode);
          }
        });
      };
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", init());
    </script>
  </body>
</html>
